<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n" 
      xmlns:meta="http://xml.zope.org/namespaces/meta"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      meta:interpolation="true"
      i18n:domain="nuplone"
      tal:define="tools context/@@tools">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" type="text/css" media="all" href="${tools/portal/++resource++NuPlone.style}/form/base.css"/>
  </head>
  <body id="links" class="dropSheet">
    <h1 i18n:translate="header_place_link">Place a Link</h1>

    <div id="external" class="formSection">
      <form action="${request/getURL}" method="${view/method}" enctype="${view/enctype}">
        <fieldset class="concise">
          <tal:widget replace="structure view/widgets/URL/render" />
          <tal:widget replace="structure view/widgets/title/render" />
          <tal:widget replace="structure view/widgets/new_window/render" />
        </fieldset>
        <div class="buttonBar">
          <button name="form.buttons.save" class="save" type="button" i18n:translate="button_save_changes">Save changes</button>
          <button name="form.buttons.cancel" class="cancel" type="button" i18n:translate="button_cancel">Cancel</button>
        </div>
      </form>
    </div>
    <script type="text/javascript" src="${tools/portal/++resource++NuPlone.libraries}/rangy-core.js"></script>
    <script type="text/javascript" src="${tools/portal/++resource++NuPlone.libraries}/jquery-1.4.4.js"></script>
    <script type="text/javascript" src="${tools/portal/++resource++NuPlone.libraries}/jquery.form.js"></script>
    <script type="text/javascript" meta:interpolation="false">
// <![CDATA[
    function reset() {
        $("#external form")[0].reset();
        $("em.message.warning").remove();
    }

    function hide() {
        var topDoc = window.frameElement.ownerDocument;
        $("#linkFrame", topDoc).hide();
    }


    function show(el) {
        var topDoc = window.frameElement.ownerDocument;

        if (el===undefined) {
            reset();
        } else {
            var topWindow = topDoc.defaultView!==undefined ? topDoc.defaultView : topDoc.parentWindow;
            topWindow.getSelection().selectAllChildren(el);
            $("input[name=form.widgets.new_window:list]").get(0).checked = (el.target==="_blank");
            $("input[name=form.widgets.URL]").val(el.href);
            $("input[name=form.widgets.title]").val(el.title);
        }

        $("#linkFrame", topDoc).show();
    }


    function removeLink() {
        var topDoc = window.frameElement.ownerDocument,
            topWindow = topDoc.defaultView!==undefined ? topDoc.defaultView : topDoc.parentWindow,
            selection = rangy.getSelection(topWindow),
            range, link, found;

        if (selection.rangeCount===0 || selection.isCollapsed)
            return;
        link = selection.anchorNode;
        found=false;
        while (link!==null && !found) {
            if (link.nodeType===Node.ELEMENT_NODE && link.tagName==="A")
                found=true;
            else
              link=link.parentNode;
        }
        if (!found)
            return;

        var $link = $(link);
        $link.replaceWith($link.contents());
    }


    function InsertURL(url, title, newwindow) {
        var topDoc = window.frameElement.ownerDocument,
            topWindow = topDoc.defaultView!==undefined ? topDoc.defaultView : topDoc.parentWindow,
            selection = rangy.getSelection(topWindow),
            range, link, found;

        if (selection.rangeCount===0)
            selection.addRange(range=rangy.createRange(topDoc));
        else
            range = selection.getRangeAt(0);

        if (range.collapsed || !range.canSurroundContents()) {
              link = topDoc.createElement("A");
              link.appendChild(topDoc.createTextNode(title || url));
              range.insertNode(link);
        } else {
          // Try to find a parent link
            link = range.startContainer;
            found=false;
            while (link!==null && !found) {
                if (link.nodeType===Node.ELEMENT_NODE && link.tagName==="A")
                    found=true;
                else
                  link=link.parentNode;
            }
            if (!found) {
                link = topDoc.createElement("A");
                range.surroundContents(link);
            }
        }
        if (url.indexOf(":")===-1 && url[0]!=="/")
            url = "http://"+url;
        link.href = url;
        link.target = newwindow ? "_blank" : "";
        link.title = title || "";
    }

    $("button.cancel").live("click", hide);

    $("button.save").live("click", function() {
        var form = this.form,
            link = form["form.widgets.URL"].value,
            title = form["form.widgets.title"].value,
            newwindow = form["form.widgets.new_window:list"].checked;
        InsertURL(link, title, newwindow);
        hide();
    });
// ]]>
    </script>
  </body>
</html>
